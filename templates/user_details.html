{% extends "base.html" %}

{% block title %}{{ user.fname }} {{ user.lname }}{% endblock %}

{% block content %}
<div class="currently-playing">
    <!-- Display in carousel so no pagination -->
    {% if current_games %}
        <h2>Currently Playing</h2>
        {% for game in current_games %}
            <div class="currently-playing-item" id="main-{{ game.game_id }}">
                <a href="/games/{{ game.game_id }}">{{ game.name }}</a>
                <img src="{{ game.covers[0].url }}" style="width: 33%; height: 33%">
                {% if session.get("user_id") %}
                    {% if session["user_id"] == user.user_id %}
                        <a class="update-notes" id="{{ game.game_id }}" href="#">Update Notes</a>
                        <div class="currently-playing-notes" id="div-{{ game.game_id }}" style="display: none">
                            <form action="/users/{{ user.user_id }}" method="POST" class="notes-form" id="form-{{ game.game_id }}">
                                <label>Hours Played so Far:</label> 
                                {% if game.time_played %}
                                <input class="time" id="time-{{ game.game_id }}" type="number" name="time_played" value="{{ game.time_played }}">
                                {% else %}
                                <input class="time" id="time-{{ game.game_id }}" type="number" name="time_played" value="0">
                                {% endif %}
                                <input class="notes" id="notes-{{ game.game_id }}" type="textarea" name="notes" value="{{ game.notes }}">
                                <input type="submit" name="submit" value="Update Notes">
                            </form>
                            <button type="button" class="finish-button" id="finish-game-{{ game.game_id }}">Finish Game</button>
                            <div class="publish-review" id="publish-{{ game.game_id }}" style="display: none">
                                <p>Final Score: </p>
                                <input class="score" id="score-{{ game.game_id }}" type="number" name="score">
                                <button type="button" class="publish-button" id="publish-review-{{ game.game_id }}">Publish</button>
                            </div>
                        </div>
                    {% endif %}
                {% endif %}
            </div>    
        {% endfor %}
        <p id="fake-flash" style="display: none">Your notes have been updated.</p>
    {% endif %}
</div>


<div class="row game-reviews">
    {% if user.reviews %}
        {% if num_pages > 1 %}
            <h2 class="paginated-header"></h2>
            <div class="col-lg-4 col-md-6 col-xs-12 paginated-reviews"></div>
            {% for index in range(1, num_pages + 1) %}
                <a class="pagination" id="{{ index }}" href="/users/{{ user.user_id }}">{{ index }}</a>
            {% endfor %}
        {% else %}
            <h2>Reviews</h2>
            {% for review in reviews %}
                <div class="col-lg-4 col-md-6 col-xs-12">
                    <h4><a href="/games/{{ review.game.game_id }}">{{ review.user.username }}</a></h4>
                    <strong>{{ review.score }}</strong>
                    {% if review.comment %}
                        <p>{{ review.comment }}</p>
                    {% endif %}
                </div>
            {% endfor %}
        {% endif %}
    {% endif %}
</div>

<script type="text/javascript">
    var userId = "{{ user.user_id }}";
    var paginatedReviews = $("div.paginated-reviews");
    var paginatedHeader = $("div.paginated-header");

    var urlIndex = 1;

    var getReviews = function (){
        var maxReview = urlIndex * 10;
        var data = {"userId": userId, "maxReview": maxReview};

        $.get("/get_user_reviews.json", data, setPaginatedReviews);
    };

    var setPaginatedReviews = function (results) {
        paginatedHTML = "";
        for (var i = 0; i < results.length; i++){
            paginatedHTML = (paginatedHTML + "<div class='col-lg-4 col-md-6 col-xs-12'><h4><a href='/games/" + results[i]['game_id'] + "'>" +
                results[i]['name'] + "</a></h4><strong>" + results[i]['score'] + "</strong>");
            if (results[i]["comment"]){
                paginatedHTML = paginatedHTML + "<p>" + results[i]["comment"] + "</p>";
            }
            paginatedHTML = paginatedHTML + "</div>";
        }
        paginatedReviews.html(paginatedHTML);
    };

    $("a.pagination").on("click", function (evt) {
        evt.preventDefault();
        var index = $(this).attr("id");
        urlIndex = parseInt(index) ;
        getReviews();
    });

    $(document).ready(getReviews());

    var removeGame = function(results) {
        $("div#main-" + results["game_id"]).toggle()
    };

    $("a.update-notes").on("click", function (evt) {
        evt.preventDefault()
        var gameId = $(this).attr("id");
        $("div#div-" + gameId).toggle();
    });

    $("button.finish-button").on("click", function() {
        var gameId = $(this).attr("id")
        gameId = gameId.split("-")[2]
        console.log("Clicked on " + gameId)
        $("div#publish-" + gameId).toggle()
    });

    $("button.publish-button").on("click", function() {
        var gameId = $(this).attr("id")
        gameId = gameId.split("-")[2]
        var formValues = {"user_id": "{{ user.user_id }}",
                  "game_id": gameId,
                  "notes": $("#notes-" + gameId).val(),
                  "time_played": $("#time-" + gameId).val(),
                  "score": $("#score-" + gameId).val()};
        $.post("/publish_review", formValues, removeGame)
    });

    var gameUpdated = function(results) {
        $("p#fake-flash").toggle();
        setTimeout(function () {
            $("p#fake-flash").toggle();
        }, 3000);
    };

    $("form.notes-form").submit(function (evt) {
        evt.preventDefault();
        var gameId = $(this).attr("id");
        gameId = gameId.split("-")[1]
        $("div#div-" + gameId).toggle();
        var formValues = {"user_id": "{{ user.user_id }}",
                      "game_id": gameId,
                      "notes": $("#notes-" + gameId).val(),
                      "time_played": $("#time-" + gameId).val()};
        $.post("/update_notes", formValues, gameUpdated);
    });


</script>
{% endblock %}